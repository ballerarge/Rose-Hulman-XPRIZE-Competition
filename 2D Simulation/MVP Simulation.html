<!DOCTYPE html>
<html lang="en">
<head>
	<title>2D Block World Simulation</title>

	<meta charset="UTF-8">

	<meta http-equiv="pragma" content="no-cache" />

	<link rel="stylesheet" type="text/css" href="index.css">

  	<link href="http://fonts.googleapis.com/css?family=Corben:bold" rel="stylesheet" type="text/css">

 	<link href="http://fonts.googleapis.com/css?family=Nobile" rel="stylesheet" type="text/css">

  <style>
    body {
      background: url(background.jpg) repeat 0 0;
    }
  </style>

</head>

<body oncontextmenu="return false;">

	<div class = "taskOverviewWrapper" id = "taskOverviewWrapper">
		<div style="text-align:center">
			<div class="popup" onclick="popUpGameIntro()" style="cursor: pointer; font-size:18px; font-family:verdana"><font color = "white">Introduction of the game</font>
				<span class="popuptext" id="myPopup" style="font-size:12px; font-family:verdana"></span>
			</div>
			<p class = "helper" style="font-size:12px; font-family:verdana">(click again to close it)</p>
		</div>
  	</div>

	<div class = "gadgetWrapper">
		<small><small><small>
		<p class = "taskQ" id = "taskQ" style = "font-size: 30px"></p>
		</small></small></small>

		<div class = "instruction" id="instruction" onclick="instructiontime()" style="font-family:verdana">
		    <label>
		        Enter instructions	:
		        <input id="txt_instruction" type="text" />
		    </label>

		    <button class = "buttonenter" onclick="inputlength()">Enter</button>

		    <div class = "numofwords" id="numofwords"></div>
		</div>

		<div class = "show" id="show">
			<p class = "movement" style="font-size:20px; font-family:verdana">Movement</p>
			<p class = "showmovement" id = "showmovement" style = "font-size: 40px; text-align: center">0</p>
		</div>
		<div class = "gestureToggle" id="gestureToggle"></div>
    <button class = "buttonStart" onclick="StartGame()" >Start</button>

	<button class = "buttonEnd" onclick="endGame()" >End</button>

    <div class = "wordsForUser1" id="wordsForUser1" style="font-family: Arial, Helvetica, sans-serif;" >
    	<label>
            Words For User 1:
            <input id="search_words_1_text" type="text" />
        </label>
    </div>

    <div class = "wordsForUser2" id="wordsForUser2" style="font-family: Arial, Helvetica, sans-serif;" >
    	<label>
            Words For User 2:
            <input id="search_words_2_text" type="text" />
        </label>
    </div>
    	<p class = "gesture" style="font-size:20px; font-family:verdana">Gesture</p>
    	<p class = "movement" style="font-size:20px; font-family:verdana">Movement</p>
		<p class = "gestureCount" id = "gestureCount" style = "font-size: 40px; text-align: center">0</p>
		<p class = "MovementCount" id = "MovementCount" style = "font-size: 40px; text-align: center">0</p>
	</div>

















	<script type="text/javascript" src="index.js"></script>

  	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>

	<script src="/socket.io/socket.io.js"></script>

	<script type="text/javascript">
		initBlocks();
		initInstructions();
		initFlipColors();
		initFlipLetters();
		initTaskID();
		setTaskHeader();
		setSearchFieldOne();
		setSearchFieldTwo();
		document.getElementById("myPopup").innerHTML = introductions[taskID];

		var socket = io.connect("http://localhost:8080");

		var color = ['red', 'blue','green','orange','yellow'];

		function initBlocks() {
			var container = document.createElement("div");
			container.id = "container";
			container.ondblclick = function() {
				gestureCount++;
				setGesture();
				send_gesture_to_server();
			};
			container.style.fontSize = "40px";
			document.body.appendChild(container);

			var position_x = [];var position_y = [];
			for (var i = 0; i < NumBlocks; i++) {
				var color_x= Math.floor(Math.random() * 5);
				// var block_to_add = document.createElement("div");
				var l = Math.floor(Math.random() * 7);
				var tLeft = Math.floor(Math.random()*22.8) * 50,
					tTop  = Math.floor(Math.random()*10.8) * 50;
				var x = -1;
				for (var j = 0; j < position_x.length; j ++) {
					if (position_x[j] == tLeft && position_y[j] == tTop) {
						x = j;
					}
				}
				while (x != -1) {
					if (Math.abs(position_y[x] - tTop) >= 50) break;
					tLeft = Math.floor(Math.random()*22.8) * 50;
					tTop  = Math.floor(Math.random()*10.8) * 50;
					var x = -1;
					for (var j = 0; j < position_x.length; j ++) {
						if (position_x[j] == tLeft && position_y[j] == tTop) {
							x = j;
						}
					}
				}
				previous_left.push(tLeft);previous_top.push(tTop);

				$("#container").append("<div class = \"block\" id =\"block"+i+"\" style=\"left:"+tLeft+"px; top:"+tTop+"px; background: " + color[color_x] + "\" oncontextmenu=\"flipBlock(\'block" + i + "\'); send_flip_to_server(\'block" + i + "\')\">"+letters[l]+"</div>");
			}
		}

		function send_gesture_to_server() {
			socket.emit('receive_gesture_data', gestureCount);
		}

		socket.on('update_gesture_data', function(data) {
			gestureCount = data;
			setGesture();
		});

	</script>

	<script type="text/javascript" >
		var socket = io.connect("http://localhost:8080");

		var username = prompt('Please enter your name.');

		socket.emit('username', username);

		var z = 1;

		socket.on('update_position', function (data) {
			
			var left = data.left;
			var top = data.top;
			var block = data.block_id;
			$("#" + block).css({
				left: left + "px",
				top: top + "px"
			});
			$("#" + block).css('z-index', ++z);
		});

		socket.on('update_flip_block', function (block_id) {
			flipBlock(block_id);
		});

		var left_array = [];
		var top_array = [];
		var current_colors = [];
		var current_letters = [];


		for (var i = 0; i < NumBlocks; i++) {
			var position = $("#block" + i).position();
			var current_color = $("#block" + i).css("background-color");
			var current_letter = $("#block" + i).text();
			left_array.push(position.left);
			top_array.push(position.top);
			current_colors.push(current_color);
			current_letters.push(current_letter);
		}

		socket.emit('setInitialPosition', {
			numBlocks: NumBlocks,
			lefts: left_array,
			tops: top_array,
			colors: current_colors,
			flipColorArray: flipColorArray,
			letters: current_letters,
			flipLetterArray: flipLetterArray,
			currentTask: taskID,
			movement_count: actualMove,
			gesture_count: gestureCount
		});

		socket.on('setInitialPosition', function(data) {
			var container = document.getElementById("container");
			
			if (data != null) {
				flipColorArray = data.flipColorArray.slice(0);
				flipLetterArray = data.flipLetterArray.slice(0);
				NumBlocks = data.numBlocks;
				taskID = data.currentTask;
				actualMove = data.movement_count;
				gestureCount = data.gesture_count;
				setTaskHeader();
				setSearchFieldOne();
				setSearchFieldTwo();
				document.getElementById("myPopup").innerHTML = introductions[taskID];

				while(container.firstChild) {
					container.removeChild(container.firstChild);
				}

				for (var i = 0; i < NumBlocks; i++) {
					$("<div class = \"block\" id =\"block"+i+"\" style=\"left:"+data.lefts[i]+"px; top:"+data.tops[i]+"px; background: " + data.colors[i] + "\" oncontextmenu=\"flipBlock(\'block" + i + "\'); \"send_flip_to_server(\'block" + i + "\')\">"+data.letters[i]+"</div>").appendTo(container);
				}
			}
		});

		function send_flip_to_server(block_id) {
			socket.emit('receive_flip_block', block_id);
		}

		$(document).ready(function() {
    		$(".draggable").draggable();
			
			$('.draggable').each(function(el){
			    var tLeft = Math.floor(Math.random()*1140) + 1,
			    tTop  = Math.floor(Math.random()*540) + 1;
			    $(el).css({position:'relative', left: 1140, top: 540});
			});
		});

		var z = 1;
		$( init );
		function init() {
			for (var i = 0; i < NumBlocks; i++) {
				$('#block' + i).draggable({containment: '#container', start: function(event, ui) {
					$(this).css('z-index', ++z);
					var Startpos = $(this).position();
					previous_left[i] = Startpos.left;previous_top[i] = Startpos.top;
        			movementstarttime = new Date().getTime();
        			movementdate = getDateTime();
				}, stop: function(event, ui) {
					var Stoppos = $(this).position();
					if (Stoppos.left!=previous_left[i] || Stoppos.top!=previous_top[i]) {
						start.push(movementdate);
						end.push(getDateTime());
						interval.push(new Date().getTime() - movementstarttime);
						type.push("Movement");
						actualMove++;
						setMovement();
						send_movement_to_server();
					}
				}, drag: function(event, ui) {
					var coord = $(this).position();
					var block_id = $(this).attr('id');
					socket.emit('receive_position', {
						block_id: block_id,
						left: coord.left,
						top: coord.top
					});
				}

				});
			}
		}

		function send_movement_to_server() {
			socket.emit('receive_movement_data', actualMove);
		}

		socket.on('update_movement_data', function(data) {
			actualMove = data;
			setMovement();
		});
	</script>

	<script type="text/javascript">
		for (var i = 0; i < NumBlocks; i++) {
			$("#block" + i).draggable({
			});
		}
	</script>

	<script type="text/javascript">
		for (var i = 0; i < NumBlocks; i++) {
			var blockid = document.getElementById('block'+i);
			if(blockid) {
				if(NumBlocks >= Object.keys(startPosMap).length){
					var pos = blockid.style;
					startPosMap['block'+i] = pos;
				}
			}

		}
	</script>

</body>
</html>
